{"version":3,"sources":["index.es6"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/*\n * @file Entrance\n * @author Bighead\n */\ndefine(function (require) {\n    \n    var $ = window.$ = require('jquery');\n    var etpl = require('etpl');\n    var draggableDom = $('[data-draggable]');\n    var sceneDom = $('.cap-scene');\n    var transformTpl = ['<!-- target: transformTpl -->',\n        'translateX(${translateX}px) translateY(${translateY}px)',\n        'scaleX(${scaleX}) scaleY(${scaleY})',\n        'skewX(${skewX}) skewY(${skewY})',\n        'rotate(${rotate}deg)'].join(' ');\n\n    /*\n     * transform2D矩阵转KV\n     * @param  {string} matrixString transform2D矩阵\n     * @return {Object}              KV\n     */\n    function matrix2kv(matrixString) {\n        var matrixArray = matrixString.replace(/matrix\\(|\\)/g, '').split(',');\n        var rotate = Math.atan2(matrixArray[1], matrixArray[0]);\n        var quadraticSum = Math.pow(matrixArray[0], 2) + Math.pow(matrixArray[1], 2);\n        var scaleX = Math.sqrt(quadraticSum);\n        var scaleY = (matrixArray[0] * matrixArray[3] - matrixArray[2] * matrixArray[1]) / scaleX;\n        var skewX = Math.atan2(matrixArray[0] * matrixArray[2] + matrixArray[1] * matrixArray[3], quadraticSum);\n\n        return {\n            rotate: rotate / (Math.PI / 180),\n            scaleX: scaleX,\n            scaleY: scaleY,\n            skewX: skewX / (Math.PI / 180),\n            skewY: 0,\n            translateX: +matrixArray[4].trim(),\n            translateY: +matrixArray[5].trim()\n        };\n    }\n\n    /*\n     * 通过transform矩阵获取某点真实坐标\n     * @param  {Object} point        某点原坐标\n     * @param  {string} matrixString transform矩阵字符串\n     * @return {Object}              换算后的坐标\n     */\n    function getTransformPositionWithMatrix(point, matrixString) {\n        var matrixArray = matrixString.replace(/matrix\\(|\\)|\\ /g, '').split(',');\n        var newX = (+point.x * +matrixArray[0]) + (+point.y * +matrixArray[2]) + (+matrixArray[4]);\n        var newY = (+point.x * +matrixArray[1]) + (+point.y * +matrixArray[3]) + (+matrixArray[5]);\n\n        return {\n            x: newX,\n            y: newY\n        };\n    }\n\n    /*\n     * 获取某dom的transform-origin相对于父节点的准确坐标\n     * @param  {html dom} dom dom节点\n     * @return {Object}     坐标\n     */\n    function getAbsolutePositionOfTransformOrigin(dom) {\n        var $dom = $(dom);\n        var originString = $dom.css('transform-origin');\n        var originArray = originString.replace(/px/g, '').split(' ');\n        var originPosition = {\n            x: originArray[0],\n            y: originArray[1]\n        };\n        var transformMatrix = $dom.css('transform');\n        var domPosition = $dom.position();\n\n        var originPositionWithTransform = getTransformPositionWithMatrix(originPosition, transformMatrix);\n\n        return {\n            x: domPosition.top + originPositionWithTransform.x,\n            y: domPosition.left + originPositionWithTransform.y\n        };\n    }\n\n    /*\n     * 获得两点间距离\n     * @param  {Object} point1 点1\n     * @param  {Object} point2 点2\n     * @return {number}        距离\n     */\n    function getDistanceBetweenTwoPoints(point1, point2) {\n        return Math.sqrt(Math.pow((point2.x - point1.x), 2) + Math.pow((point2.y - point1.y), 2));\n    }\n\n    /*\n     * 获取当前锚点控制的element\n     * @param  {Object} anchor 锚点\n     * @return {jQuery Object}        锚点控制的element\n     */\n    function getElementByAnchor(anchor) {\n        var $anchor = $(anchor);\n        return $anchor.parents('[data-draggable=element]');\n    }\n\n    var dragElementHandler = {\n        mousedown: function (event) {\n            var target = event.target;\n            var $target = $(target);\n\n            if (!$target.data('draggable')) {\n                return;\n            }\n\n            var mouseX = event.clientX;\n            var mouseY = event.clientY;\n\n            draggableDom.addClass('cap-element-static');\n            $target.removeClass('cap-element-static');\n\n            target.beginMousePosition = {\n                x: mouseX,\n                y: mouseY\n            };\n\n            var a = matrix2kv($target.css('transform'));\n\n            target.beginDomPosition = {\n                x: a.translateX,\n                y: a.translateY\n            };\n\n            target.absolutePositionOfTransformOrigin = getAbsolutePositionOfTransformOrigin(target);\n\n        },\n        mousemove: function (event) {\n            var target = event.target;\n            var $target = $(target);\n\n            if (!target.beginMousePosition) {\n                return;\n            }\n\n            var mouseX = event.clientX;\n            var mouseY = event.clientY;\n            var offsetMousePosition = {\n                x: mouseX - target.beginMousePosition.x,\n                y: mouseY - target.beginMousePosition.y\n            };\n\n            var curTransform = matrix2kv($target.css('transform'));\n\n            curTransform.translateX = target.beginDomPosition.x + offsetMousePosition.x;\n            curTransform.translateY = target.beginDomPosition.y + offsetMousePosition.y;\n            $target.css('transform', etpl.render('transformTpl', curTransform));\n\n        },\n        mouseup: function (event) {\n            var target = event.target;\n\n            target.beginMousePosition = null;\n            target.beginDomPosition = null;\n\n            draggableDom.removeClass('cap-element-static');\n        }\n    };\n\n    var dragAnchorHandler = {\n        mousedown: function (event) {\n            var target = event.target;\n            var $target = $(target);\n\n            var element = getElementByAnchor($target);\n\n            console.log(element[0].absolutePositionOfTransformOrigin)\n\n            if (!$target.data('draggable')) {\n                return;\n            }\n\n            var mouseX = event.clientX;\n            var mouseY = event.clientY;\n\n            draggableDom.addClass('cap-element-static');\n            $target.removeClass('cap-element-static');\n\n            sceneDom.beginMousePosition = {\n                x: mouseX,\n                y: mouseY\n            };\n        },\n        mousemove: function (event) {\n\n            if (!sceneDom.beginMousePosition) {\n                return;\n            }\n            var mouseX = event.clientX;\n            var mouseY = event.clientY;\n            var offsetMousePosition = getDistanceBetweenTwoPoints(sceneDom.beginMousePosition, {\n                x: mouseX,\n                y: mouseY\n            });\n        },\n        mouseup: function (event) {\n            sceneDom.beginMousePosition = null;\n        }\n    };\n\n    sceneDom.on('mousedown', function (event) {\n        var target = event.target;\n        var $target = $(target);\n        var dragType = $target.data('draggable');\n\n        if (dragType === 'element') {\n            dragElementHandler.mousedown(event);\n        }\n\n        if (dragType === 'anchor') {\n            sceneDom.eventType = 'anchor';\n            dragAnchorHandler.mousedown(event);\n        }\n    });\n\n    sceneDom.on('mousemove', function (event) {\n        var target = event.target;\n        var $target = $(target);\n        var dragType = $target.data('draggable');\n\n        if (dragType === 'element') {\n            dragElementHandler.mousemove(event);\n        }\n\n        if (sceneDom.eventType === 'anchor') {\n            dragAnchorHandler.mousemove(event);\n        }\n    });\n\n    sceneDom.on('mouseup', function (event) {\n        var target = event.target;\n        var $target = $(target);\n        var dragType = $target.data('draggable');\n\n        if (dragType === 'element') {\n            dragElementHandler.mouseup(event);\n        }\n\n        if (sceneDom.eventType === 'anchor') {\n            sceneDom.eventType = null;\n            sceneDom.beginMousePosition = null;\n            dragAnchorHandler.mouseup(event);\n        }\n    });\n\n    function init() {\n        etpl.compile(transformTpl);\n    }\n\n    return {\n        init: init\n    };\n});\n"]}